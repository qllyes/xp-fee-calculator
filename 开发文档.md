# 新品铺货费计算器 - 开发文档 (V1.5)

## 1. 项目概述
本项目是一个基于 Python 和 Streamlit 构建的 Web 工具，旨在为采购和供应链部门提供标准化、自动化的新品铺货费用计算服务。

### 核心功能
- **单品计算器**：支持标准通道（黄/蓝/绿）自动计数和自定义通道手动输入。
- **批量计算器**：支持通过 Excel 模板批量导入 SKU 进行费用计算并导出结果。
- **自动加载与更新提示**：应用启动时自动加载最新的门店主数据，并在界面右上角显示数据更新时间。
- **动态配置**：所有计算系数均通过 `config/coefficients.xlsx` 进行管理。

## 2. 系统架构

### 目录结构
```text
xp-fee-calculator/
├── config/
│   └── coefficients.xlsx      # 核心系数配置文件
├── data/
│   ├── store_master.xlsx      # 门店主数据（自动计数源）
│   ├── batch_template.xlsx    # 批量导入模板
│   └── rule_description.pdf   # 业务规则说明文档
├── src/
│   ├── main.py                # 应用入口
│   ├── ui/
│   │   └── app.py             # Streamlit UI 逻辑
│   ├── core/
│   │   ├── config_loader.py   # 配置加载逻辑
│   │   ├── store_manager.py   # 门店计数与通道逻辑
│   │   ├── calculator.py      # 核心费用计算引擎
│   │   └── file_utils.py      # 文件读写工具类
│   └── sync_db_to_exel.py     # 数据库同步脚本
└── pyproject.toml             # 项目依赖配置
```

### 核心模块说明
- **`ui/app.py`**: 负责界面渲染、用户交互及数据缓存。移除了侧边栏上传入口，改为自动从 `data/store_master.xlsx` 加载数据，并显示 `门店表更新时间`。
- **`core/calculator.py`**: 实现核心计算逻辑，包括基础费用查找、SKU 折扣应用、系数乘积计算及保底费校验。
- **`core/store_manager.py`**: 处理标准通道的门店筛选逻辑及自定义通道的门店数提取。

## 3. 业务逻辑与计算规则

### 3.1 门店通道定义
| 通道名称 | 包含销售规模 |
| :--- | :--- |
| **🟡 黄色** | 超级旗舰店、旗舰店、大店 |
| **🔵 蓝色** | 超级旗舰店、旗舰店、大店、中店、小店 |
| **🟢 绿色** | 超级旗舰店、旗舰店、大店、中店、小店、成长店 |
| **⚪ 自定义** | 由用户手动输入上述 6 种类型的门店数量 |

### 3.2 计算公式
`最终费用 = max(保底费, 理论总费用 * SKU折扣系数)`
其中：
`理论总费用 = Σ(单店基准金额 * 系数A * 系数B * 系数C * 系数D * 系数E * 对应店型数量)`

- **系数A**：毛利率系数
- **系数B**：付款方式系数
- **系数C**：进价系数
- **系数D**：退货条件系数
- **系数E**：供应商类型系数

## 4. 开发与部署指南

### 环境配置
项目使用 `uv` 进行包管理。
```bash
# 安装依赖
uv sync
```

### 运行应用
```bash
# 启动 Streamlit 应用
uv run streamlit run src/main.py
```

### 性能优化说明
- **缓存机制**：UI 层对 `coefficients.xlsx` 和 `store_master.xlsx` 进行了缓存处理。如果修改了这些文件，Streamlit 会自动识别文件变化并刷新缓存，或者用户可以手动在界面点击 "Clear Cache"。
- **数据库同步**：通过 `sync_db_to_exel.py` 定期将数据库中的门店主数据同步到本地 Excel，以确保前端查询的高性能。

## 5. 常见问题 (FAQ)
- **Q: 为什么修改了 Excel 系数表界面没变化？**
  - A: Streamlit 缓存可能未及时更新，尝试刷新页面或重启服务。
- **Q: 自定义通道输入框不全？**
  - A: 请确保 `app.py` 已更新至 V1.5 版本，该版本支持全部 6 种销售规模。
