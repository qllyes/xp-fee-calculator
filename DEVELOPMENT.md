# 新品铺货费计算器 (XP Fee Calculator) 开发文档

## 1. 项目概述
本项目是一个基于 Python Streamlit 的 Web 应用程序，旨在帮助业务人员快速计算新品铺货费用。系统支持单品交互式计算和批量 Excel 导入计算，并根据最新的业务规则（如战区筛选、处方限制、多维度系数调整）进行精确计费。

## 2. 技术栈
- **语言**: Python 3.10+
- **框架**: Streamlit (Web UI)
- **数据处理**: Pandas, OpenPyXL
- **配置管理**: Excel (`coefficients.xlsx`)
- **数据源**: Excel (`store_master.xlsx`)

## 3. 核心功能模块

### 3.1 单品计算器 (Tab 1)
用户在界面上输入单品的各项属性，系统实时计算铺货费用。
- **输入项**:
  - 新品大类（决定基础费用和保底费）
  - 供应商类型、付款方式、退货条件（影响折扣系数）
  - SKU数、进价、预估毛利率（影响折扣系数）
  - 处方类别（用于剔除受限门店）
  - **通道选择**:
    - **标准通道**: 预定义的门店组合（🟡 中店以上、🔵 成长店以上、🟢 全量门店）。
    - **自定义通道**: 支持“手动输入门店数”或“勾选特定销售规模”。
  - **战区选择**: 支持按“提报战区”筛选门店（如：华东战区），默认为“全集团”。

### 3.2 批量计算器 (Tab 2)
用户上传 Excel 文件，系统批量计算每一行的费用并导出结果。
- **模板要求**: 包含“新品大类”、“铺货通道”、“处方类别”、“提报战区”等关键列。
- **逻辑**:
  - 自动识别“提报战区”列，若为空则默认为“全集团”。
  - 自动识别“处方类别”并进行受限门店剔除。
  - 结果包含：理论费用、折扣系数、折后费用、门店分布详情、计算系数详情、备注（剔除信息）。

## 4. 核心业务逻辑

### 4.1 门店筛选逻辑 (`src/core/store_manager.py`)
系统根据以下三个维度取交集筛选门店：
1.  **销售规模 (Channel)**:
    - `中店以上`: [超级旗舰店, 旗舰店, 大店, 中店]
    - `成长店以上`: [超级旗舰店, 旗舰店, 大店, 中店, 小店]
    - `全量门店`: [所有类型]
2.  **战区 (War Zone)**:
    - 根据 `store_master.xlsx` 中的 `提报战区` 字段进行精确匹配。
    - 若选择“全集团”，则不进行战区过滤。
3.  **处方限制 (Prescription Restriction)**:
    - 根据 `处方类别` 映射到 `受限批文分类编码`。
    - 若门店的 `受限批文分类编码` 包含该新品的编码，则该门店被剔除。

### 4.2 费用计算逻辑 (`src/core/calculator.py`)
$$
\text{最终费用} = \lceil (\sum (\text{门店数} \times \text{单店基础费}) \times \prod \text{各项系数}) / 10 \rceil \times 10
$$
- **取整规则**: 先计算折后金额，向上取整到最近的 10 元（例如 123 -> 130, 120 -> 120）。
- **兜底规则**: 若计算结果低于该品类的“最低保底费”，则取保底费。

## 5. 项目结构
```
xp-fee-calculator/
├── config/
│   └── coefficients.xlsx      # 核心配置文件（系数、基价、战区列表等）
├── data/
│   ├── store_master.xlsx      # 门店主数据
│   ├── 处方类别与批文分类表.xlsx # 处方限制映射表
│   └── batch_template.xlsx    # 批量导入模板
├── src/
│   ├── core/
│   │   ├── calculator.py      # 费用计算核心逻辑
│   │   ├── config_loader.py   # 配置加载逻辑
│   │   ├── store_manager.py   # 门店筛选与统计逻辑
│   │   └── file_utils.py      # 文件读取工具
│   └── ui/
│       └── app.py             # Streamlit 主程序
└── .streamlit/
    └── config.toml            # Streamlit 配置文件
```

## 6. 配置维护
所有业务规则均可通过修改 `config/coefficients.xlsx` 实现热更新，无需修改代码：
- **基础费用**: 不同大类在不同店型的单价。
- **系数表**: SKU数量、毛利率、进价等对应的折扣。
- **提报战区**: 维护下拉框可选的战区列表。

## 7. 运行方式
```bash
uv run streamlit run src/ui/app.py
```
