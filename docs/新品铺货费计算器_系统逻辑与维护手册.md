# 铺货费计算逻辑说明文档

## 1. 核心公式
最终铺货费 = MAX( (基础费用 × 综合折扣系数), 最低保底费 )

计算系统执行流程如下：
1. **基础费用计算**：根据门店数量和单价计算理论总费用。
2. **折扣系数计算**：综合六大维度的系数得出最终折扣率。
3. **特例与取整**：处理特殊免单逻辑，并对金额进行取整（向上取整至十位）。
4. **保底兜底比较**：与最低保底线比较，取较大值作为最终结果。

---

## 2. 详细计算逻辑拆解

### 2.1 基础费用 (Base Fee)
基础费用取决于**新品大类**与**各业态门店数量**。
- **计算方法**：遍历前端录入的每一类业态（如A类店、B类店等），计算 `单店费用 * 店数`，最后将所有业态的费用累加。
- **数据来源**：配置表 `[基础费用]` sheet。

### 2.2 综合折扣系数 (Discount Factor)
综合系数由以下 6 项系数**连乘**得出，最终结果保留 2 位小数。

#### (1) 单次引入SKU数量折扣
- **逻辑**：根据`同一供应商单次引进SKU数`所在的区间确定系数。
- **维度**：区分**新品大类**（不同大类可能有不同的数量门槛规则）。
- **数据来源**：配置表 `[单次引入SKU数量折扣]` sheet。

#### (2) 毛利率系数
- **逻辑**：根据`预估毛利率(%)`所在的区间确定系数。
- **数据来源**：配置表 `[毛利率系数]` sheet。

#### (3) 付款方式系数
- **逻辑**：根据`付款方式`（如 账期、现结 等）直接查找对应系数。
- **数据来源**：配置表 `[付款方式系数]` sheet。

#### (4) 底价系数
- **逻辑**：根据商品`底价`所在的区间确定系数。
- **数据来源**：配置表 `[底价系数]` sheet。

#### (5) 退货条件系数 (包含复杂规则)
- **逻辑**：
    - **优先判断比例规则（动态数值匹配）**：系统首先检查该退货条件（如"效期可退"）是否存在于复杂规则表中。如果存在，则读取用户填写的动态数值 `退货比例(%)`，根据其所在的 `min` 和 `max` 范围，在 `[退货比例系数]` 中确定对应档位的固定折扣系数。
    - **普通规则**：如果上述不匹配，则直接根据退货条件名称在普通系数表中查找对应固定系数。
- **数据来源**：配置表 `[退货比例系数]` (优先) 和 `[退货条件系数]` sheet。

#### (6) 供应商类型系数
- **逻辑**：根据`供应商类型`（如 生产企业、经销商 等）直接查找对应系数。
- **数据来源**：配置表 `[供应商类型系数]` sheet。

### 2.3 特殊免单与取整规则

1. **特殊免单规则 ("养生中药"特例)**
   - **触发条件**：**新品大类** 为 `养生中药` **且** **预估毛利率** `>= 65%`。
   - **执行结果**：
     - 综合折扣系数强制置为 `0`。
     - **豁免保底**：最低保底费强制视为 `0`（即不执行兜底逻辑）。
     - 最终费用为 0 元。

2. **金额取整规则**
   - **公式**：`Math.ceil(计算金额 / 10) * 10`
   - **说明**：计算出的折后金额**向上取整到十位数**。
   - *示例*：计算结果 1234 元 -> 取整为 1240 元。

### 2.4 最低保底逻辑 (Minimum Floor)

系统会根据该商品的采购属性（`统采` 或 `地采`）设定不同的保底线。

- **逻辑**：
    1. 根据**新品大类**查表，分别获取该大类对应的 `统采保底费` 和 `地采保底费`。
    2. 依据用户录入的 `统采or地采` 字段，确定**当前应执行的保底金额**。
    3. **比较逻辑**：
       - 如果 (折后费用 < 保底金额) 且 (未触发免单特例)：
         - 最终铺货费 = 保底金额
         - 标记为：`触发最低兜底`
       - 否则：
         - 最终铺货费 = 折后费用
- **数据来源**：配置表 `[最低保底费]` sheet。

---

## 3. 门店筛选与数量计算逻辑

门店数量 (`store_counts`) 是基础费用计算的核心输入。系统支持两种筛选模式：**标准通道** 和 **自定义通道**。

### 3.1 筛选流程
1. **基础范围筛选 (Channel Selection)**
   - **标准通道 (包含智能推荐)**：选取特定规模集合组合（如 `"旗舰店及以上"`、`"全量门店"` 等）。系统会基于**退货条件**、**付款方式**（是否≥60天账期）和**新品大类**（是否为中西成药）三大维度，自动进行智能规则计算，为用户默认推荐一个最符合公司铺货规则的标准通道。
   - **自定义通道**：
     - **手动输入**：直接输入各类型门店的具体数量（此模式下不依赖门店主数据表）。
     - **标签筛选**：基于门店主数据，通过多维标签（省市、店龄、商圈等）动态圈选门店。

2. **属性过滤 (Attribute Filtering)**
   - 在选择“标签筛选”或计算标准通道时，支持按以下维度过滤：
     - **地理位置**：省公司、省份、城市
     - **门店属性**：店龄店型、行政区划等级、公域O2O店型
     - **业务标属性**：医保店、O2O门店、统筹店
   - **客流商圈特例**：采用模糊匹配（集合交集逻辑），只要门店的商圈字段中包含用户选中的任一商圈即可匹配。

3. **战区过滤 (War Zone Filtering)**
   - 如果指定了 `提报战区` (且非 "全集团")，仅保留属于该战区的门店。

4. **处方受限剔除 (Negative Screening)**
   - **逻辑**：根据商品的 `处方类别` 映射到的 `批文分类编码`，检查门店的 `受限批文分类编码` 字段。如果该编码出现在某门店的受限列表中，该门店将被**强制剔除**。

5. **门店黑名单过滤 (Blacklist Filtering) [最新补充]**
   - **逻辑**：依靠 `新品费剔除门店黑名单.xlsx` 文件作为配置依据。
   - 匹配规则为**模糊包含匹配**。只要黑名单中配置的 `处方类别or新品大类` 值（例如：“处方药”）被包含在前端传来的分类值内（例如：“10-处方药”），那么该条黑名单即命中。命中的黑名单所包含的所有 `门店sapid` 也会在计算前被**强制剔除**。

---

## 4. 批量计算逻辑

批量计算支持通过 Excel 上传多条数据一次性完成计算。

### 4.1 空值/默认值处理机制 (Fault Tolerance)
为了提高批量处理的成功率，系统读取 Excel 时会对关键字段的空值进行以下默认填充：

| 字段名 | 空值 (Null/NaN/空串) 处理逻辑 | 备注 |
| :--- | :--- | :--- |
| **统采or地采** | 默认为 `统采` | 涉及保底金额判断 |
| **提报战区** | 默认为 `全集团` | 即不进行特定战区筛选 |
| **退货比例(%)** | 默认为 `100` | 对于效期可退类商品，空值默认等于 100% 退货比例予以优先高折扣计算 |
| **处方类别** | 默认为 `None` | 不进行受限剔除 |

### 4.2 计算与导出流程
1. **导入与清洗**：解析上传的 Excel 文件，并应用上述默认值逻辑补全缺失信息与清洗脏数据。
2. **逐行运算**：
   - 对每一行数据，根据 `铺货通道` 和 `提报战区` 调用核心门店算法。
   - 自动执行受限门店剔除逻辑和门店黑名单剔除逻辑。
   - 将得到的有效门店数传入 `calculate_fee` 函数。
3. **结果附加**：
   在原 Excel 数据基础上，新增以下列并导出：
   - `理论总新品铺货费 (元)`
   - `折扣`
   - `折后总新品铺货费 (元)`
   - `[详情]计算系数`：详细列出命中所触发的所有规则系数（如 `{毛利: 1.0, 底价: 0.9...}`）。
   - `[详情]门店分布`：如 `{'超级旗舰店': 5, '旗舰店': 10...}`
   - `备注`：若有门店因受限或黑名单被剔除，会特别标注 `已剔除门店数(受限+黑名单)：X`，否则为空。

---

## 5. 前端交互选项数据源

以下表格列出了前端页面各下拉框、筛选器的选项值的数据来源：

| 前端字段 | 物理文件路径 | 来源 Sheet / Key | 数据处理逻辑 / 备注 |
| :--- | :--- | :--- | :--- |
| **新品大类** | `config/coefficients.xlsx` | `[基础费用]` | 取该表中的“新品大类”列去重后作为选项。 |
| **供应商类型** | `config/coefficients.xlsx` | `[供应商类型系数]` | 取“供应商类型”列作为选项。 |
| **付款方式** | `config/coefficients.xlsx` | `[付款方式系数]` | 取“付款方式”列作为选项。 |
| **退货条件** | `config/coefficients.xlsx` | `[退货条件系数]` 与<br>`[退货比例系数]` | 合并两张表中的条件名称，去重后排序。 |
| **战区选择** | `config/coefficients.xlsx` | `[提报战区]` | 取第一列数据，代码中默认在首位追加“全集团”。 |
| **处方类别** | `data/处方类别与批文分类表.xlsx` | `Sheet1` | 读取“处方类别”列。用于关联批文编码进行门店剔除，以及黑名单模糊筛查。 |
| **门店黑名单库** | `data/新品费剔除门店黑名单.xlsx` | `Sheet1` | 基于 "门店sapid" 和 "处方类别or新品大类" 执行交叉比对清洗与排除。 |
| **省/市/区联动** | `data/region_map.xlsx`<br>*(若无则用 store_master.xlsx)* | `Sheet1` | 动态扫描数据表中的省公司、省份、城市列，实现级联筛选。 |
| **门店属性筛选器** | `data/dim_metadata.json` | JSON Keys | 由 `sync_db_to_exel.py` 扫描最新门店数据生成，包含各筛选列的可用枚举值。 |
| **是否医保/O2O等** | `data/dim_metadata.json` | JSON Keys | 同上，通常为 `['是', '否']`。 |

---

## 6. 配置表结构维护规范 (Configuration Schema)

为了保证程序正确通过代码读取配置表，**`config/coefficients.xlsx`** 中的各 Sheet 必须包含以下关键列名。维护时**严禁修改表头名称**。

| Sheet 名称 | 关键列名 (必须存在) | 说明 |
| :--- | :--- | :--- |
| **单次引入SKU数量折扣** | `新品大类`, `min`, `max`, `discount` | 定义数量区间的折扣率 |
| **毛利率系数** | `min`, `max`, `coeff` | 定义毛利区间的系数 |
| **底价系数** | `min`, `max`, `coeff` | 定义价格区间的系数 |
| **退货比例系数** | `退货条件`, `min`, `max`, `系数` | 注意：此处列名为“系数”而非“coeff” |
| **最低保底费** | `新品大类`, `统采保底费`, `地采保底费` | 定义各类别的兜底红线 |
| **基础费用** | `新品大类`, `超级旗舰店`, `旗舰店`... | 除去第一列外，其他列应为合法的门店类型名称 |

*注：区间判断逻辑通常为 `min <= value < max`（左闭右开），维护数据时请确保区间连续且不重叠。*

---

## 7. 系统文件职责映射 (Codebase Map)

此表用于快速定位业务逻辑所在的物理文件，便于技术排查。

| 业务模块 | 文件路径 | 核心职责 |
| :--- | :--- | :--- |
| **费用计算引擎** | `src/core/calculator.py` | 实现 `calculate_fee` 函数，包含所有费用公式、特例免单、保底逻辑。 |
| **配置加载器** | `src/core/config_loader.py` | 负责读取 Excel 配置文件，处理 Sheet 拆分与格式转换。 |
| **门店计算引擎** | `src/core/store_manager.py` | 负责 `calc_auto_counts`，实现门店筛选、战区过滤、受限门店及黑名单剔除。 |
| **用户界面 (UI)** | `src/ui/app.py` | 基于 Streamlit 的前端交互，处理用户输入逻辑，以及通道智能推荐判断。 |
| **元数据同步** | `src/sync_db_to_exel.py` | (维护工具) 扫描门店主数据，提取筛选项元数据并生成 `dim_metadata.json`。 |

---

## 8. 关键数据字典 (Data Dictionary Protection)

**警告**：前端 UI (`app.py`) 在收集用户输入后，会构建一个名为 `row_data` 的字典传递给后台核心引擎。后台引擎依赖**固定的 Key (键名)** 来获取数据。

**在修改代码或 UI 逻辑时，严禁修改下表中左侧的 Key 名称**，否则会导致后台计算抛出未命中的参数异常。

| 必须保持不变的 Key | 前端 UI 对应含义 (可随意修改文案) | 备注 |
| :--- | :--- | :--- |
| `新品大类` | 新品一级大类 / 类目 | 对应 `base_fees` 查找，及黑名单剔除关联 |
| `统采or地采` | 采购模式 / 采购类型 | 对应 `min_fee_floors` 查找 |
| `同一供应商单次引进SKU数` | SKU数量 / 引进数 | - |
| `预估毛利率(%)` | 毛利率 / 预估综合毛利 | - |
| `付款方式` | 结算方式 / 账期 | - |
| `供应商类型` | 供应商属性 | - |
| `底价` | 供货价 / 成本价 | - |
| `退货条件` | 退货条款 | - |
| `退货比例(%)` | 退货率 / 折旧率 | 用于动态档次阶梯计算匹配 |
| `处方类别` | 处方属性 | 用于门店受限校验，及黑名单模糊剔除关联 |

*开发准则：您可以随意修改 UI 页面上显示的文字（例如将“统采or地采”标签改为“采购模式”），但必须确保传给后端的字典 Key 依然为 `"统采or地采"`。*
